<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoftSynergy - Panel Pracownika</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'softsynergy-blue': '#2563eb',
                        'softsynergy-orange': '#f97316',
                        'softsynergy-dark': '#1e293b',
                        'softsynergy-light': '#f8fafc'
                    }
                }
            }
        }
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/recording.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .recording {
            animation: recording 1s infinite;
        }
        @keyframes recording {
            0%, 100% { background-color: #ef4444; }
            50% { background-color: #dc2626; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <img src="/logo.png" alt="SoftSynergy" class="h-10 w-10 mr-3">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">SoftSynergy</h1>
                        <p class="text-sm text-softsynergy-orange font-medium">Innovative Software Solutions</p>
                        <p class="text-xs text-gray-500">Cold Call Manager</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="status-indicator" class="flex items-center">
                        <div class="w-3 h-3 bg-gray-400 rounded-full mr-2"></div>
                        <span class="text-sm text-gray-600">Sprawdzanie statusu...</span>
                    </div>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Wyloguj
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Login Form -->
        <div id="login-section" class="max-w-md mx-auto">
            <div class="bg-white rounded-lg shadow-md p-8">
                <div class="text-center mb-8">
                    <i class="fas fa-user-circle text-6xl text-blue-600 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-900">Logowanie</h2>
                    <p class="text-gray-600">Zaloguj się do systemu cold calling</p>
                </div>
                
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="email" name="email" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Hasło</label>
                        <input type="password" id="password" name="password" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <button type="submit" id="login-btn"
                            class="w-full bg-softsynergy-blue hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors">
                        <i class="fas fa-sign-in-alt mr-2"></i>Zaloguj się
                    </button>
                </form>
                
                <div id="login-error" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded hidden">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span id="login-error-text"></span>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboard" class="hidden">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                            <i class="fas fa-phone text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Łączne rozmowy</p>
                            <p class="text-2xl font-bold text-gray-900" id="total-calls">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-600">
                            <i class="fas fa-check-circle text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Udane rozmowy</p>
                            <p class="text-2xl font-bold text-gray-900" id="successful-calls">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                            <i class="fas fa-calendar-check text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600">Umówione spotkania</p>
                            <p class="text-2xl font-bold text-gray-900" id="meetings-scheduled">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Lead Card -->
            <div id="current-lead-card" class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Aktualny Lead</h3>
                <div id="lead-status" class="px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                    Oczekiwanie na leada
                </div>
            </div>
            
            <!-- Phone Search Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">
                    <i class="fas fa-search mr-2 text-blue-600"></i>Wyszukaj numer telefonu
                </h3>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <input type="text" id="phone-search" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                               placeholder="Wpisz numer telefonu lub jego część (min. 3 cyfry)...">
                    </div>
                    <button id="search-phone-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-search mr-2"></i>Szukaj
                    </button>
                </div>
                
                <!-- Search Results -->
                <div id="search-results" class="mt-4 hidden">
                    <h4 class="font-medium text-gray-900 mb-3">Wyniki wyszukiwania:</h4>
                    <div id="search-results-list" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
            
            <div id="lead-info" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium text-gray-900 mb-2">Dane kontaktowe</h4>
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <i class="fas fa-user text-gray-400 w-5"></i>
                                    <span id="lead-name" class="ml-3 text-gray-900"></span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-phone text-gray-400 w-5"></i>
                                    <span id="lead-phone" class="ml-3 text-gray-900"></span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-envelope text-gray-400 w-5"></i>
                                    <span id="lead-email" class="ml-3 text-gray-900"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-medium text-gray-900 mb-2">Notatki</h4>
                            <p id="lead-notes" class="text-gray-600 text-sm bg-gray-50 p-3 rounded"></p>
                            
                            <div class="mt-4">
                                <h4 class="font-medium text-gray-900 mb-2">Historia rozmów</h4>
                                <div id="call-history" class="space-y-2 max-h-32 overflow-y-auto">
                                    <!-- Call history will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="no-lead-message" class="text-center py-8">
                    <i class="fas fa-user-slash text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600">Brak dostępnych leadów</p>
                    <p class="text-sm text-gray-500">Sprawdź ponownie za chwilę</p>
                </div>
            </div>

            <!-- Call Controls -->
            <div id="call-controls" class="bg-white rounded-lg shadow-lg p-6 hidden">
                <div class="text-center mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Kontrola rozmowy</h3>
                    <div id="call-timer" class="text-2xl font-mono text-blue-600">00:00</div>
                </div>
                
                <div class="flex flex-wrap justify-center gap-4">
                    <!-- Start Call Button -->
                    <button id="start-call-btn" class="bg-softsynergy-orange hover:bg-orange-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-phone mr-2"></i>Rozpocznij rozmowę
                    </button>
                    
                    <!-- Recording Button -->
                    <button id="recording-btn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-medium transition-colors hidden">
                        <i class="fas fa-microphone mr-2"></i>Nagrywaj
                    </button>
                    
                    <!-- End Call Buttons -->
                    <div id="end-call-buttons" class="hidden space-x-2">
                        <button id="no-answer-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-phone-slash mr-1"></i>Nie odebrał
                        </button>
                        
                        <button id="not-interested-btn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-times mr-1"></i>Niezainteresowany
                        </button>
                        
                        <button id="meeting-scheduled-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-calendar-plus mr-1"></i>Umówione spotkanie
                        </button>
                        
                        <button id="next-call-btn" class="bg-softsynergy-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-arrow-right mr-1"></i>Następny telefon
                        </button>
                        
                        <button id="schedule-call-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-clock mr-1"></i>Zaplanuj telefon
                        </button>
                    </div>
                </div>
                
                <!-- Call Notes -->
                <div id="call-notes-section" class="mt-6 hidden">
                    <label for="call-notes" class="block text-sm font-medium text-gray-700 mb-2">Notatki z rozmowy</label>
                    <textarea id="call-notes" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Dodaj notatki z rozmowy..."></textarea>
                </div>
                
                <!-- Meeting Details -->
                <div id="meeting-details-section" class="mt-6 hidden">
                    <h4 class="font-medium text-gray-900 mb-3">Szczegóły spotkania</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="meeting-date" class="block text-sm font-medium text-gray-700 mb-1">Data spotkania</label>
                            <input type="datetime-local" id="meeting-date" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="meeting-location" class="block text-sm font-medium text-gray-700 mb-1">Miejsce</label>
                            <input type="text" id="meeting-location" placeholder="np. Biuro, Online"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="meeting-notes" class="block text-sm font-medium text-gray-700 mb-1">Notatki do spotkania</label>
                        <textarea id="meeting-notes" rows="2" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="Dodatkowe informacje o spotkaniu..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Recordings Section -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Moje nagrania</h3>
                    <button id="refresh-recordings-btn" class="bg-softsynergy-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Odśwież
                    </button>
                </div>
                <div id="recordings-list" class="space-y-3">
                    <!-- Recordings will be populated here -->
                </div>
            </div>

            <!-- Availability Toggle -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Status dostępności</h3>
                        <p class="text-sm text-gray-600">Zarządzaj swoją dostępnością do odbierania leadów</p>
                    </div>
                    <button id="availability-toggle" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-toggle-off mr-2"></i>Niedostępny
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Przetwarzanie...</p>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="message-container" class="fixed top-4 right-4 z-50"></div>

    <!-- Schedule Call Modal -->
    <div id="schedule-call-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-clock mr-2 text-green-600"></i>Zaplanuj następny telefon
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="schedule-date" class="block text-sm font-medium text-gray-700 mb-1">Data i godzina</label>
                            <input type="datetime-local" id="schedule-date" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <div>
                            <label for="schedule-notes" class="block text-sm font-medium text-gray-700 mb-1">Notatki (opcjonalne)</label>
                            <textarea id="schedule-notes" rows="3" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                      placeholder="Dlaczego planujesz telefon na ten czas?"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-3 mt-6">
                        <button id="cancel-schedule-btn" class="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                            Anuluj
                        </button>
                        <button id="confirm-schedule-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-check mr-2"></i>Zaplanuj
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let currentUser = null;
        let currentLead = null;
        let currentCall = null;
        let callStartTime = null;
        let callTimer = null;
        let isRecording = false;
        let callRecorder = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Check if user is already logged in
            const token = localStorage.getItem('token');
            if (token) {
                verifyToken();
            } else {
                showLoginSection();
            }

            // Setup event listeners
            setupEventListeners();
        }

        function setupEventListeners() {
            // Login form
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // Call controls
            document.getElementById('start-call-btn').addEventListener('click', startCall);
            document.getElementById('recording-btn').addEventListener('click', toggleRecording);
            document.getElementById('no-answer-btn').addEventListener('click', () => endCall('no_answer'));
            document.getElementById('not-interested-btn').addEventListener('click', () => endCall('not_interested'));
            document.getElementById('meeting-scheduled-btn').addEventListener('click', showMeetingDetails);
            document.getElementById('next-call-btn').addEventListener('click', getNextLead);
            document.getElementById('schedule-call-btn').addEventListener('click', showScheduleModal);
            
            // Phone search
            document.getElementById('search-phone-btn').addEventListener('click', searchPhone);
            document.getElementById('phone-search').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchPhone();
                }
            });
            
            // Schedule modal
            document.getElementById('cancel-schedule-btn').addEventListener('click', hideScheduleModal);
            document.getElementById('confirm-schedule-btn').addEventListener('click', confirmSchedule);
            
            // Availability toggle
            document.getElementById('availability-toggle').addEventListener('click', toggleAvailability);
            
            // Recordings
            document.getElementById('refresh-recordings-btn').addEventListener('click', loadRecordings);
            
            // Initialize recorder
            callRecorder = new CallRecorder();
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            showLoading(true);
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('token', data.token);
                    currentUser = data.user;
                    showDashboard();
                    initializeSocket();
                    loadUserStats();
                    getCurrentLead();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Błąd połączenia z serwerem');
            } finally {
                showLoading(false);
            }
        }

        async function verifyToken() {
            try {
                const response = await fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    showDashboard();
                    initializeSocket();
                    loadUserStats();
                    getCurrentLead();
                    loadRecordings();
                } else {
                    localStorage.removeItem('token');
                    showLoginSection();
                }
            } catch (error) {
                localStorage.removeItem('token');
                showLoginSection();
            }
        }

        function handleLogout() {
            localStorage.removeItem('token');
            currentUser = null;
            currentLead = null;
            
            if (socket) {
                socket.disconnect();
            }
            
            showLoginSection();
        }

        function initializeSocket() {
            socket = io();
            
            socket.on('connect', () => {
                socket.emit('join-employee-room', currentUser.id);
                updateStatusIndicator(true);
            });
            
            socket.on('disconnect', () => {
                updateStatusIndicator(false);
            });
            
            socket.on('call-started', (data) => {
                console.log('Call started:', data);
            });
            
            socket.on('call-ended', (data) => {
                console.log('Call ended:', data);
                if (data.nextLead) {
                    currentLead = data.nextLead;
                    displayCurrentLead();
                }
            });
        }

        async function loadUserStats() {
            try {
                const response = await fetch('/api/employees/stats', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('total-calls').textContent = data.stats.totalCalls;
                    document.getElementById('successful-calls').textContent = data.stats.successfulCalls;
                    document.getElementById('meetings-scheduled').textContent = data.stats.meetingsScheduled;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function getCurrentLead() {
            try {
                const response = await fetch('/api/leads/my-lead', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.lead) {
                        currentLead = data.lead;
                        displayCurrentLead();
                    } else {
                        showNoLeadMessage();
                    }
                }
            } catch (error) {
                console.error('Error getting current lead:', error);
            }
        }

        function displayCurrentLead() {
            if (!currentLead) {
                showNoLeadMessage();
                return;
            }
            
            document.getElementById('lead-info').classList.remove('hidden');
            document.getElementById('no-lead-message').classList.add('hidden');
            document.getElementById('call-controls').classList.remove('hidden');
            
            // Populate lead info
            document.getElementById('lead-name').textContent = currentLead.name;
            document.getElementById('lead-phone').textContent = currentLead.phone;
            document.getElementById('lead-email').textContent = currentLead.email;
            document.getElementById('lead-notes').textContent = currentLead.notes || 'Brak notatek';
            
            // Check if there's an active call
            if (currentLead.hasActiveCall) {
                // Show call in progress state
                document.getElementById('start-call-btn').classList.add('hidden');
                document.getElementById('recording-btn').classList.remove('hidden');
                document.getElementById('end-call-buttons').classList.remove('hidden');
                document.getElementById('call-notes-section').classList.remove('hidden');
                
                // Update status
                document.getElementById('lead-status').textContent = 'Rozmowa w toku';
                document.getElementById('lead-status').className = 'px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800';
                
                // Set current call info
                currentCall = { id: currentLead.activeCallId };
                callStartTime = new Date(); // We don't have exact start time, so use current time
                startCallTimer();
                
                showSuccess('Rozmowa już trwa - kontynuuj');
            } else {
                // Show normal state
                document.getElementById('start-call-btn').classList.remove('hidden');
                document.getElementById('recording-btn').classList.add('hidden');
                document.getElementById('end-call-buttons').classList.add('hidden');
                document.getElementById('call-notes-section').classList.add('hidden');
                
                // Update status
                document.getElementById('lead-status').textContent = 'Przypisany';
                document.getElementById('lead-status').className = 'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800';
            }
            
            // Display call history
            displayCallHistory(currentLead.callHistory || []);
        }

        function showNoLeadMessage() {
            document.getElementById('lead-info').classList.add('hidden');
            document.getElementById('no-lead-message').classList.remove('hidden');
            document.getElementById('call-controls').classList.add('hidden');
            
            document.getElementById('lead-status').textContent = 'Brak leada';
            document.getElementById('lead-status').className = 'px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800';
        }

        function displayCallHistory(history) {
            const historyContainer = document.getElementById('call-history');
            historyContainer.innerHTML = '';
            
            if (history.length === 0) {
                historyContainer.innerHTML = '<p class="text-gray-500 text-sm">Brak historii rozmów</p>';
                return;
            }
            
            history.forEach(call => {
                const callElement = document.createElement('div');
                callElement.className = 'text-xs text-gray-600 bg-gray-50 p-2 rounded';
                callElement.innerHTML = `
                    <div class="flex justify-between">
                        <span>${new Date(call.timestamp).toLocaleString()}</span>
                        <span class="font-medium">${getCallResultText(call.result)}</span>
                    </div>
                    ${call.notes ? `<div class="mt-1 text-gray-500">${call.notes}</div>` : ''}
                `;
                historyContainer.appendChild(callElement);
            });
        }

        function getCallResultText(result) {
            const results = {
                'no_answer': 'Nie odebrał',
                'not_interested': 'Niezainteresowany',
                'meeting_scheduled': 'Umówione spotkanie',
                'call_recorded': 'Rozmowa nagrana'
            };
            return results[result] || result;
        }

        async function startCall() {
            if (!currentLead) return;
            
            try {
                const response = await fetch('/api/leads/start-call', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ leadId: currentLead.id })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentCall = data.call;
                    callStartTime = new Date();
                    startCallTimer();
                    
                    // Update UI
                    document.getElementById('start-call-btn').classList.add('hidden');
                    document.getElementById('recording-btn').classList.remove('hidden');
                    document.getElementById('end-call-buttons').classList.remove('hidden');
                    document.getElementById('call-notes-section').classList.remove('hidden');
                    
                    // Update lead status
                    document.getElementById('lead-status').textContent = 'Rozmowa w toku';
                    document.getElementById('lead-status').className = 'px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800';
                    
                    showSuccess('Rozmowa rozpoczęta');
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Błąd rozpoczęcia rozmowy');
            }
        }

        function startCallTimer() {
            callTimer = setInterval(() => {
                if (callStartTime) {
                    const elapsed = Math.floor((new Date() - callStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    document.getElementById('call-timer').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        function stopCallTimer() {
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
        }

        async function toggleRecording() {
            const btn = document.getElementById('recording-btn');
            
            if (!isRecording) {
                try {
                    // Rozpocznij nagrywanie
                    await callRecorder.startRecording();
                    isRecording = true;
                    
                    btn.innerHTML = '<i class="fas fa-stop mr-2"></i>Zatrzymaj nagrywanie';
                    btn.classList.add('recording');
                    showSuccess('🎤 Nagrywanie rozpoczęte');
                    
                } catch (error) {
                    console.error('Błąd rozpoczęcia nagrywania:', error);
                    showError('Błąd rozpoczęcia nagrywania: ' + error.message);
                }
            } else {
                try {
                    // Zatrzymaj nagrywanie
                    await callRecorder.stopRecording();
                    isRecording = false;
                    
                    btn.innerHTML = '<i class="fas fa-microphone mr-2"></i>Nagrywaj';
                    btn.classList.remove('recording');
                    showSuccess('🛑 Nagrywanie zatrzymane');
                    
                } catch (error) {
                    console.error('Błąd zatrzymania nagrywania:', error);
                    showError('Błąd zatrzymania nagrywania: ' + error.message);
                }
            }
        }

        async function endCall(result) {
            if (!currentLead) return;
            
            const notes = document.getElementById('call-notes').value;
            let meetingDetails = null;
            let recordingUrl = null;
            
            // Zatrzymaj nagrywanie jeśli trwa
            if (isRecording && callRecorder) {
                try {
                    recordingUrl = await callRecorder.stopRecording();
                    isRecording = false;
                    console.log('🎤 Nagranie zapisane:', recordingUrl);
                } catch (error) {
                    console.error('Błąd zapisywania nagrania:', error);
                    isRecording = false;
                }
            }
            
            if (result === 'meeting_scheduled') {
                const meetingDate = document.getElementById('meeting-date').value;
                const meetingLocation = document.getElementById('meeting-location').value;
                const meetingNotes = document.getElementById('meeting-notes').value;
                
                if (!meetingDate) {
                    showError('Wybierz datę spotkania');
                    return;
                }
                
                meetingDetails = {
                    scheduledDate: new Date(meetingDate),
                    location: meetingLocation,
                    notes: meetingNotes
                };
            }
            
            try {
                const response = await fetch('/api/leads/end-call', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        leadId: currentLead.id,
                        result: result,
                        notes: notes,
                        meetingDetails: meetingDetails,
                        recordingUrl: recordingUrl
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    stopCallTimer();
                    resetCallUI();
                    
                    if (result === 'meeting_scheduled') {
                        showSuccess('Spotkanie zostało umówione');
                    } else {
                        showSuccess('Rozmowa zakończona');
                    }
                    
                    // Get next lead and refresh recordings
                    setTimeout(() => {
                        getNextLead();
                        loadRecordings();
                    }, 2000);
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Błąd zakończenia rozmowy');
            }
        }

        function showMeetingDetails() {
            // Pokaż sekcję z datą spotkania
            document.getElementById('meeting-details-section').classList.remove('hidden');
            
            // Ustaw dzisiejszą datę jako domyślną
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(10, 0, 0, 0);
            
            document.getElementById('meeting-date').value = tomorrow.toISOString().slice(0, 16);
            
            // Dodaj przycisk potwierdzenia
            const confirmButton = document.createElement('button');
            confirmButton.id = 'confirm-meeting-btn';
            confirmButton.className = 'bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm mt-3';
            confirmButton.innerHTML = '<i class="fas fa-check mr-1"></i>Potwierdź spotkanie';
            
            // Usuń poprzedni przycisk jeśli istnieje
            const existingBtn = document.getElementById('confirm-meeting-btn');
            if (existingBtn) {
                existingBtn.remove();
            }
            
            document.getElementById('meeting-details-section').appendChild(confirmButton);
            
            // Event listener dla potwierdzenia
            confirmButton.addEventListener('click', () => {
                endCall('meeting_scheduled');
            });
        }

        async function getNextLead() {
            // Najpierw zakończ aktualną rozmowę jeśli trwa
            if (currentCall) {
                await endCall('completed');
            }
            
            showLoading(true);
            
            try {
                await getCurrentLead();
            } finally {
                showLoading(false);
            }
        }

        function resetCallUI() {
            document.getElementById('start-call-btn').classList.remove('hidden');
            document.getElementById('recording-btn').classList.add('hidden');
            document.getElementById('end-call-buttons').classList.add('hidden');
            document.getElementById('call-notes-section').classList.add('hidden');
            document.getElementById('meeting-details-section').classList.add('hidden');
            
            document.getElementById('call-timer').textContent = '00:00';
            document.getElementById('call-notes').value = '';
            document.getElementById('meeting-date').value = '';
            document.getElementById('meeting-location').value = '';
            document.getElementById('meeting-notes').value = '';
            
            // Usuń przycisk potwierdzenia spotkania jeśli istnieje
            const confirmBtn = document.getElementById('confirm-meeting-btn');
            if (confirmBtn) {
                confirmBtn.remove();
            }
            
            isRecording = false;
            callStartTime = null;
            currentCall = null;

            // Reset recorder
            if (callRecorder && isRecording) {
                callRecorder.stopRecording();
                isRecording = false;
            }
        }

        async function loadRecordings() {
            try {
                const response = await fetch('/api/recordings/employee/recordings', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('recordings-list');
                    container.innerHTML = '';
                    
                    if (data.recordings.length === 0) {
                        container.innerHTML = '<p class="text-gray-500 text-center py-4">Brak nagrań</p>';
                        return;
                    }
                    
                    data.recordings.forEach(recording => {
                        const recordingElement = document.createElement('div');
                        recordingElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                        
                        const duration = Math.floor(recording.duration / 60) + ':' + 
                                       (recording.duration % 60).toString().padStart(2, '0');
                        
                        const leadName = recording.lead ? recording.lead.name : 'Nieznany lead';
                        const leadPhone = recording.lead ? recording.lead.phone : 'Brak numeru';
                        
                        recordingElement.innerHTML = `
                            <div class="flex items-center">
                                <i class="fas fa-microphone text-blue-600 mr-3"></i>
                                <div>
                                    <div class="font-medium text-gray-900">${leadName}</div>
                                    <div class="text-sm text-gray-600">
                                        ${new Date(recording.startTime).toLocaleString()} • ${duration}
                                    </div>
                                    ${recording.lead ? `<div class="text-xs text-gray-500">${leadPhone}</div>` : ''}
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <audio controls class="h-8">
                                    <source src="${recording.recordingUrl}" type="audio/webm">
                                    Twoja przeglądarka nie obsługuje odtwarzacza audio.
                                </audio>
                            </div>
                        `;
                        
                        container.appendChild(recordingElement);
                    });
                } else {
                    showError(data.message);
                }
            } catch (error) {
                console.error('Błąd ładowania nagrań:', error);
                showError('Błąd ładowania nagrań');
            }
        }

        async function toggleAvailability() {
            try {
                const response = await fetch('/api/employees/toggle-availability', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const btn = document.getElementById('availability-toggle');
                    if (data.isAvailable) {
                        btn.innerHTML = '<i class="fas fa-toggle-on mr-2"></i>Dostępny';
                        btn.className = 'bg-softsynergy-orange hover:bg-orange-700 text-white px-6 py-3 rounded-lg font-medium transition-colors';
                    } else {
                        btn.innerHTML = '<i class="fas fa-toggle-off mr-2"></i>Niedostępny';
                        btn.className = 'bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-medium transition-colors';
                    }
                    
                    showSuccess(data.message);
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Błąd aktualizacji statusu');
            }
        }

        function showLoginSection() {
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function updateStatusIndicator(connected) {
            const indicator = document.getElementById('status-indicator');
            const dot = indicator.querySelector('.w-3');
            const text = indicator.querySelector('span');
            
            if (connected) {
                dot.className = 'w-3 h-3 bg-green-400 rounded-full mr-2';
                text.textContent = 'Połączony';
            } else {
                dot.className = 'w-3 h-3 bg-red-400 rounded-full mr-2';
                text.textContent = 'Rozłączony';
            }
        }

        function showSuccess(message) {
            showMessage(message, 'success');
        }

        function showError(message) {
            showMessage(message, 'error');
        }

        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            const messageEl = document.createElement('div');
            
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
            
            messageEl.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg mb-2 flex items-center`;
            messageEl.innerHTML = `
                <i class="${icon} mr-2"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }

        // Phone search functions
        async function searchPhone() {
            const phoneInput = document.getElementById('phone-search');
            const phone = phoneInput.value.trim();
            
            if (phone.length < 3) {
                showError('Wprowadź co najmniej 3 cyfry numeru telefonu');
                return;
            }
            
            try {
                const response = await fetch(`/api/leads/search-phone?phone=${encodeURIComponent(phone)}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displaySearchResults(data.leads);
                } else {
                    showError(data.message);
                }
            } catch (error) {
                console.error('Błąd wyszukiwania:', error);
                showError('Błąd wyszukiwania numeru');
            }
        }

        function displaySearchResults(leads) {
            const resultsContainer = document.getElementById('search-results');
            const resultsList = document.getElementById('search-results-list');
            
            if (leads.length === 0) {
                resultsList.innerHTML = '<p class="text-gray-500 text-sm">Nie znaleziono leadów z tym numerem telefonu</p>';
            } else {
                resultsList.innerHTML = '';
                
                leads.forEach(lead => {
                    const leadElement = document.createElement('div');
                    leadElement.className = 'bg-gray-50 p-4 rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors cursor-pointer';
                    
                    const statusColors = {
                        'new': 'bg-blue-100 text-blue-800',
                        'assigned': 'bg-yellow-100 text-yellow-800',
                        'calling': 'bg-orange-100 text-orange-800',
                        'no_answer': 'bg-red-100 text-red-800',
                        'not_interested': 'bg-gray-100 text-gray-800',
                        'meeting_scheduled': 'bg-purple-100 text-purple-800',
                        'completed': 'bg-green-100 text-green-800'
                    };
                    
                    leadElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">${lead.name}</div>
                                <div class="text-sm text-gray-600">${lead.phone}</div>
                                <div class="text-sm text-gray-600">${lead.email}</div>
                                ${lead.assignedTo ? `<div class="text-xs text-gray-500">Przypisany do: ${lead.assignedTo.name}</div>` : ''}
                            </div>
                            <div class="flex flex-col items-end space-y-2">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[lead.status] || 'bg-gray-100 text-gray-800'}">
                                    ${getStatusText(lead.status)}
                                </span>
                                <button onclick="selectLeadFromSearch('${lead.id}')" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs font-medium transition-colors">
                                    <i class="fas fa-phone mr-1"></i>Zadzwoń
                                </button>
                            </div>
                        </div>
                        ${lead.nextCallTime ? `<div class="text-xs text-gray-500 mt-2">Następny telefon: ${new Date(lead.nextCallTime).toLocaleString()}</div>` : ''}
                    `;
                    
                    resultsList.appendChild(leadElement);
                });
            }
            
            resultsContainer.classList.remove('hidden');
        }

        function getStatusText(status) {
            const statusTexts = {
                'new': 'Nowy',
                'assigned': 'Przypisany',
                'calling': 'W trakcie rozmowy',
                'no_answer': 'Nie odebrał',
                'not_interested': 'Niezainteresowany',
                'meeting_scheduled': 'Umówione spotkanie',
                'completed': 'Zakończony'
            };
            return statusTexts[status] || status;
        }

        async function selectLeadFromSearch(leadId) {
            try {
                // Set this lead as current lead
                const response = await fetch('/api/leads/my-lead', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.lead && data.lead.id === leadId) {
                    currentLead = data.lead;
                    displayCurrentLead();
                    showSuccess('Lead wybrany - możesz rozpocząć rozmowę');
                } else {
                    showError('Nie można wybrać tego leada - może być przypisany do innego pracownika');
                }
            } catch (error) {
                console.error('Błąd wyboru leada:', error);
                showError('Błąd wyboru leada');
            }
        }

        // Schedule call functions
        function showScheduleModal() {
            if (!currentLead) {
                showError('Brak aktywnego leada');
                return;
            }
            
            // Set default time to 1 hour from now
            const now = new Date();
            now.setHours(now.getHours() + 1);
            const defaultTime = now.toISOString().slice(0, 16);
            
            document.getElementById('schedule-date').value = defaultTime;
            document.getElementById('schedule-notes').value = '';
            
            document.getElementById('schedule-call-modal').classList.remove('hidden');
        }

        function hideScheduleModal() {
            document.getElementById('schedule-call-modal').classList.add('hidden');
        }

        async function confirmSchedule() {
            const scheduledDateTime = document.getElementById('schedule-date').value;
            const notes = document.getElementById('schedule-notes').value;
            
            if (!scheduledDateTime) {
                showError('Wybierz datę i godzinę');
                return;
            }
            
            if (new Date(scheduledDateTime) <= new Date()) {
                showError('Data musi być w przyszłości');
                return;
            }
            
            try {
                const response = await fetch('/api/leads/schedule-call', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        leadId: currentLead.id,
                        scheduledDateTime: scheduledDateTime,
                        notes: notes
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    hideScheduleModal();
                    showSuccess(`Telefon zaplanowany na ${new Date(scheduledDateTime).toLocaleString()}`);
                    
                    // Refresh current lead to show updated info
                    await getCurrentLead();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                console.error('Błąd planowania telefonu:', error);
                showError('Błąd planowania telefonu');
            }
        }
    </script>
</body>
</html>
