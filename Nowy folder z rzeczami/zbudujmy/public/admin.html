<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoftSynergy - Panel Administracyjny</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'softsynergy-blue': '#2563eb',
                        'softsynergy-orange': '#f97316',
                        'softsynergy-dark': '#1e293b',
                        'softsynergy-light': '#f8fafc'
                    }
                }
            }
        }
    </script>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <img src="/logo.png" alt="SoftSynergy" class="h-10 w-10 mr-3">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">SoftSynergy</h1>
                        <p class="text-sm text-softsynergy-orange font-medium">Innovative Software Solutions</p>
                        <p class="text-xs text-gray-500">Panel Administracyjny</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="status-indicator" class="flex items-center">
                        <div class="w-3 h-3 bg-gray-400 rounded-full mr-2"></div>
                        <span class="text-sm text-gray-600">Sprawdzanie statusu...</span>
                    </div>
                    <button id="logout-btn" class="bg-softsynergy-orange hover:bg-orange-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Wyloguj
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Login Form -->
        <div id="login-section" class="max-w-md mx-auto">
            <div class="bg-white rounded-lg shadow-md p-8">
                <div class="text-center mb-8">
                    <i class="fas fa-shield-alt text-6xl text-blue-600 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-900">Logowanie Administratora</h2>
                    <p class="text-gray-600">Zaloguj się do panelu administracyjnego</p>
                </div>
                
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="email" name="email" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Hasło</label>
                        <input type="password" id="password" name="password" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <button type="submit" id="login-btn"
                            class="w-full bg-softsynergy-blue hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition-colors">
                        <i class="fas fa-sign-in-alt mr-2"></i>Zaloguj się
                    </button>
                </form>
                
                <div id="login-error" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded hidden">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span id="login-error-text"></span>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="dashboard" class="hidden">
            <!-- Navigation Tabs -->
            <div class="bg-white rounded-lg shadow mb-6">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8 px-6">
                        <button id="tab-stats" class="tab-button active py-4 px-1 border-b-2 border-softsynergy-blue text-softsynergy-blue font-medium">
                            <i class="fas fa-chart-bar mr-2"></i>Statystyki
                        </button>
                        <button id="tab-leads" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            <i class="fas fa-users mr-2"></i>Leady
                        </button>
                        <button id="tab-employees" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            <i class="fas fa-user-tie mr-2"></i>Pracownicy
                        </button>
                        <button id="tab-recordings" class="tab-button py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            <i class="fas fa-microphone mr-2"></i>Nagrania
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Stats Tab -->
            <div id="stats-tab" class="tab-content">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <i class="fas fa-users text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Łączne leady</p>
                                <p class="text-2xl font-bold text-gray-900" id="total-leads">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <i class="fas fa-user-check text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Nowe leady</p>
                                <p class="text-2xl font-bold text-gray-900" id="new-leads">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                <i class="fas fa-user-clock text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Przypisane</p>
                                <p class="text-2xl font-bold text-gray-900" id="assigned-leads">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                <i class="fas fa-check-circle text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Zakończone</p>
                                <p class="text-2xl font-bold text-gray-900" id="completed-leads">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Employee Status -->
                <div class="bg-white rounded-lg shadow p-6 mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Status pracowników</h3>
                    <div id="employee-status-list" class="space-y-3">
                        <!-- Employee status will be populated here -->
                    </div>
                </div>

                <!-- Actions -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Akcje systemowe</h3>
                    <div class="flex flex-wrap gap-4">
                        <button id="distribute-leads-btn" class="bg-softsynergy-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-share-alt mr-2"></i>Dystrybuuj leady
                        </button>
                        <button id="refresh-stats-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Odśwież statystyki
                        </button>
                    </div>
                </div>
            </div>

            <!-- Leads Tab -->
            <div id="leads-tab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900">Zarządzanie leadami</h3>
                            <button id="add-lead-btn" class="bg-softsynergy-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                <i class="fas fa-plus mr-2"></i>Dodaj leada
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <!-- Filters -->
                        <div class="mb-6 flex flex-wrap gap-4">
                            <select id="status-filter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Wszystkie statusy</option>
                                <option value="new">Nowe</option>
                                <option value="assigned">Przypisane</option>
                                <option value="calling">W trakcie rozmowy</option>
                                <option value="no_answer">Nie odebrał</option>
                                <option value="not_interested">Niezainteresowany</option>
                                <option value="meeting_scheduled">Umówione spotkanie</option>
                                <option value="completed">Zakończone</option>
                            </select>
                            <button id="filter-leads-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                <i class="fas fa-filter mr-2"></i>Filtruj
                            </button>
                        </div>
                        
                        <!-- Leads Table -->
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Imię</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telefon</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Przypisany do</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Akcje</th>
                                    </tr>
                                </thead>
                                <tbody id="leads-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Leads will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Employees Tab -->
            <div id="employees-tab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900">Zarządzanie pracownikami</h3>
                            <button id="add-employee-btn" class="bg-softsynergy-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                <i class="fas fa-plus mr-2"></i>Dodaj pracownika
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Imię</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rola</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statystyki</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Akcje</th>
                                    </tr>
                                </thead>
                                <tbody id="employees-table-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Employees will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- Add Lead Modal -->
    <div id="add-lead-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Dodaj nowego leada</h3>
                <button id="close-lead-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="add-lead-form" class="space-y-4">
                <div>
                    <label for="lead-name" class="block text-sm font-medium text-gray-700 mb-1">Imię i nazwisko</label>
                    <input type="text" id="lead-name" name="name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="lead-phone" class="block text-sm font-medium text-gray-700 mb-1">Telefon</label>
                    <input type="tel" id="lead-phone" name="phone" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="lead-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="lead-email" name="email" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="lead-notes" class="block text-sm font-medium text-gray-700 mb-1">Notatki</label>
                    <textarea id="lead-notes" name="notes" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Dodatkowe informacje o leadzie..."></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-lead-btn" class="px-4 py-2 text-gray-600 hover:text-gray-800">Anuluj</button>
                    <button type="submit" class="bg-softsynergy-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>Dodaj leada
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Employee Modal -->
    <div id="add-employee-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Dodaj nowego pracownika</h3>
                <button id="close-employee-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="add-employee-form" class="space-y-4">
                <div>
                    <label for="employee-name" class="block text-sm font-medium text-gray-700 mb-1">Imię i nazwisko</label>
                    <input type="text" id="employee-name" name="name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="employee-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="employee-email" name="email" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="employee-password" class="block text-sm font-medium text-gray-700 mb-1">Hasło</label>
                    <input type="password" id="employee-password" name="password" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="employee-role" class="block text-sm font-medium text-gray-700 mb-1">Rola</label>
                    <select id="employee-role" name="role"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="employee">Pracownik</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancel-employee-btn" class="px-4 py-2 text-gray-600 hover:text-gray-800">Anuluj</button>
                    <button type="submit" class="bg-softsynergy-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>Dodaj pracownika
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Recordings Tab -->
    <div id="recordings-tab" class="tab-content hidden">
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-gray-900">Wszystkie nagrania</h3>
                    <div class="flex space-x-2">
                        <select id="recordings-employee-filter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Wszyscy pracownicy</option>
                        </select>
                        <select id="recordings-status-filter" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Wszystkie statusy</option>
                            <option value="completed">Zakończone</option>
                            <option value="in_progress">W trakcie</option>
                        </select>
                        <button id="refresh-recordings-btn" class="bg-softsynergy-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Odśwież
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <div id="recordings-list" class="space-y-4">
                    <!-- Recordings will be loaded here -->
                </div>
                
                <div id="recordings-pagination" class="mt-6 flex justify-center">
                    <!-- Pagination will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Przetwarzanie...</p>
        </div>
    </div>

    <!-- Success/Error Messages -->
    <div id="message-container" class="fixed top-4 right-4 z-50"></div>

    <script>
        // Global variables
        let socket;
        let currentUser = null;
        let currentTab = 'stats';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Check if user is already logged in
            const token = localStorage.getItem('token');
            if (token) {
                verifyToken();
            } else {
                showLoginSection();
            }

            // Setup event listeners
            setupEventListeners();
        }

        function setupEventListeners() {
            // Login form
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // Tab navigation
            document.getElementById('tab-stats').addEventListener('click', () => switchTab('stats'));
            document.getElementById('tab-leads').addEventListener('click', () => switchTab('leads'));
            document.getElementById('tab-employees').addEventListener('click', () => switchTab('employees'));
            document.getElementById('tab-recordings').addEventListener('click', () => switchTab('recordings'));
            
            // Stats actions
            document.getElementById('distribute-leads-btn').addEventListener('click', distributeLeads);
            document.getElementById('refresh-stats-btn').addEventListener('click', loadStats);
            
            // Lead management
            document.getElementById('add-lead-btn').addEventListener('click', () => showModal('add-lead-modal'));
            document.getElementById('add-lead-form').addEventListener('submit', handleAddLead);
            document.getElementById('close-lead-modal').addEventListener('click', () => hideModal('add-lead-modal'));
            document.getElementById('cancel-lead-btn').addEventListener('click', () => hideModal('add-lead-modal'));
            document.getElementById('filter-leads-btn').addEventListener('click', loadLeads);
            
            // Employee management
            document.getElementById('add-employee-btn').addEventListener('click', () => showModal('add-employee-modal'));
            document.getElementById('add-employee-form').addEventListener('submit', handleAddEmployee);
            document.getElementById('close-employee-modal').addEventListener('click', () => hideModal('add-employee-modal'));
            document.getElementById('cancel-employee-btn').addEventListener('click', () => hideModal('add-employee-modal'));
            
            // Recordings actions
            document.getElementById('refresh-recordings-btn').addEventListener('click', loadRecordings);
            document.getElementById('recordings-employee-filter').addEventListener('change', loadRecordings);
            document.getElementById('recordings-status-filter').addEventListener('change', loadRecordings);
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            showLoading(true);
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.user.role !== 'admin') {
                        showError('Wymagane uprawnienia administratora');
                        return;
                    }
                    
                    localStorage.setItem('token', data.token);
                    currentUser = data.user;
                    showDashboard();
                    initializeSocket();
                    loadStats();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Błąd połączenia z serwerem');
            } finally {
                showLoading(false);
            }
        }

        async function verifyToken() {
            try {
                const response = await fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.user.role === 'admin') {
                    currentUser = data.user;
                    showDashboard();
                    initializeSocket();
                    loadStats();
                } else {
                    localStorage.removeItem('token');
                    showLoginSection();
                }
            } catch (error) {
                localStorage.removeItem('token');
                showLoginSection();
            }
        }

        function handleLogout() {
            localStorage.removeItem('token');
            currentUser = null;
            
            if (socket) {
                socket.disconnect();
            }
            
            showLoginSection();
        }

        function initializeSocket() {
            socket = io();
            
            socket.on('connect', () => {
                updateStatusIndicator(true);
            });
            
            socket.on('disconnect', () => {
                updateStatusIndicator(false);
            });
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.getElementById(`tab-${tabName}`).classList.add('active', 'border-blue-500', 'text-blue-600');
            document.getElementById(`tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            
            currentTab = tabName;
            
            // Load data for the tab
            if (tabName === 'leads') {
                loadLeads();
            } else if (tabName === 'employees') {
                loadEmployees();
            } else if (tabName === 'recordings') {
                loadRecordings();
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('total-leads').textContent = data.stats.leads.total;
                    document.getElementById('new-leads').textContent = data.stats.leads.new;
                    document.getElementById('assigned-leads').textContent = data.stats.leads.assigned;
                    document.getElementById('completed-leads').textContent = data.stats.leads.completed;
                    
                    loadEmployeeStatus();
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadEmployeeStatus() {
            try {
                const response = await fetch('/api/admin/employees', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('employee-status-list');
                    container.innerHTML = '';
                    
                    data.employees.forEach(employee => {
                        const statusElement = document.createElement('div');
                        statusElement.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                        
                        const statusColor = employee.isAvailable ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        const statusText = employee.isAvailable ? 'Dostępny' : 'Zajęty';
                        
                        statusElement.innerHTML = `
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full mr-3 ${employee.isAvailable ? 'bg-green-400' : 'bg-red-400'}"></div>
                                <div>
                                    <div class="font-medium text-gray-900">${employee.name}</div>
                                    <div class="text-sm text-gray-600">${employee.email}</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor}">${statusText}</span>
                                <div class="text-sm text-gray-600">
                                    ${employee.stats.totalCalls} rozmów
                                </div>
                            </div>
                        `;
                        
                        container.appendChild(statusElement);
                    });
                }
            } catch (error) {
                console.error('Error loading employee status:', error);
            }
        }

        async function loadLeads() {
            try {
                const statusFilter = document.getElementById('status-filter').value;
                const url = statusFilter ? `/api/admin/leads?status=${statusFilter}` : '/api/admin/leads';
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('leads-table-body');
                    tbody.innerHTML = '';
                    
                    data.leads.forEach(lead => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        
                        const statusColor = getStatusColor(lead.status);
                        const statusText = getStatusText(lead.status);
                        
                        const now = new Date();
                        const hasTimeout = lead.nextCallTime && new Date(lead.nextCallTime) > now;
                        const timeoutBadge = hasTimeout 
                            ? `<span class="ml-2 px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Timeout do ${new Date(lead.nextCallTime).toLocaleString()}</span>`
                            : '';

                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${lead.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lead.phone}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lead.email}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor}">${statusText}</span>
                                ${timeoutBadge}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${lead.assignedTo ? lead.assignedTo.name : 'Nieprzypisany'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="deleteLead('${lead.id}')" class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading leads:', error);
            }
        }

        async function loadEmployees() {
            try {
                const response = await fetch('/api/admin/employees', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const tbody = document.getElementById('employees-table-body');
                    tbody.innerHTML = '';
                    
                    data.employees.forEach(employee => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        
                        const statusColor = employee.isAvailable ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                        const statusText = employee.isAvailable ? 'Dostępny' : 'Zajęty';
                        
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${employee.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.email}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${employee.role}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor}">${statusText}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${employee.stats.totalCalls} rozmów, ${employee.stats.successfulCalls} udanych
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="deleteEmployee('${employee.id}')" class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }

        async function handleAddLead(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const leadData = {
                name: formData.get('name'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                notes: formData.get('notes')
            };
            
            showLoading(true);
            
            try {
                const response = await fetch('/api/admin/leads', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(leadData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Lead został dodany');
                    hideModal('add-lead-modal');
                    e.target.reset();
                    if (currentTab === 'leads') {
                        loadLeads();
                    }
                    loadStats();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Błąd dodawania leada');
            } finally {
                showLoading(false);
            }
        }

        async function handleAddEmployee(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const employeeData = {
                name: formData.get('name'),
                email: formData.get('email'),
                password: formData.get('password'),
                role: formData.get('role')
            };
            
            showLoading(true);
            
            try {
                const response = await fetch('/api/admin/employees', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(employeeData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Pracownik został dodany');
                    hideModal('add-employee-modal');
                    e.target.reset();
                    if (currentTab === 'employees') {
                        loadEmployees();
                    }
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Błąd dodawania pracownika');
            } finally {
                showLoading(false);
            }
        }

        async function distributeLeads() {
            showLoading(true);
            
            try {
                const response = await fetch('/api/admin/distribute-leads', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Dystrybucja leadów zakończona');
                    loadStats();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Błąd dystrybucji leadów');
            } finally {
                showLoading(false);
            }
        }

        async function deleteLead(leadId) {
            if (!confirm('Czy na pewno chcesz usunąć tego leada?')) return;
            
            try {
                const response = await fetch(`/api/admin/leads/${leadId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Lead został usunięty');
                    loadLeads();
                    loadStats();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Błąd usuwania leada');
            }
        }

        async function deleteEmployee(employeeId) {
            if (!confirm('Czy na pewno chcesz usunąć tego pracownika?')) return;
            
            try {
                const response = await fetch(`/api/admin/employees/${employeeId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Pracownik został usunięty');
                    loadEmployees();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('Błąd usuwania pracownika');
            }
        }

        function showLoginSection() {
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function updateStatusIndicator(connected) {
            const indicator = document.getElementById('status-indicator');
            const dot = indicator.querySelector('.w-3');
            const text = indicator.querySelector('span');
            
            if (connected) {
                dot.className = 'w-3 h-3 bg-green-400 rounded-full mr-2';
                text.textContent = 'Połączony';
            } else {
                dot.className = 'w-3 h-3 bg-red-400 rounded-full mr-2';
                text.textContent = 'Rozłączony';
            }
        }

        function getStatusColor(status) {
            const colors = {
                'new': 'bg-blue-100 text-blue-800',
                'assigned': 'bg-yellow-100 text-yellow-800',
                'calling': 'bg-purple-100 text-purple-800',
                'no_answer': 'bg-orange-100 text-orange-800',
                'not_interested': 'bg-red-100 text-red-800',
                'meeting_scheduled': 'bg-green-100 text-green-800',
                'completed': 'bg-gray-100 text-gray-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function getStatusText(status) {
            const texts = {
                'new': 'Nowy',
                'assigned': 'Przypisany',
                'calling': 'W trakcie rozmowy',
                'no_answer': 'Nie odebrał',
                'not_interested': 'Niezainteresowany',
                'meeting_scheduled': 'Umówione spotkanie',
                'completed': 'Zakończone'
            };
            return texts[status] || status;
        }

        function showSuccess(message) {
            showMessage(message, 'success');
        }

        function showError(message) {
            showMessage(message, 'error');
        }

        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            const messageEl = document.createElement('div');
            
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
            
            messageEl.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg mb-2 flex items-center fade-in`;
            messageEl.innerHTML = `
                <i class="${icon} mr-2"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }

        // Recordings functions
        async function loadRecordings() {
            try {
                const employeeFilter = document.getElementById('recordings-employee-filter').value;
                const statusFilter = document.getElementById('recordings-status-filter').value;
                
                const params = new URLSearchParams();
                if (employeeFilter) params.append('employeeId', employeeFilter);
                if (statusFilter) params.append('status', statusFilter);
                
                const response = await fetch(`/api/recordings/admin/recordings?${params}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayRecordings(data.recordings);
                    displayRecordingsPagination(data.pagination);
                } else {
                    showMessage('Błąd ładowania nagrań', 'error');
                }
            } catch (error) {
                console.error('Błąd ładowania nagrań:', error);
                showMessage('Błąd ładowania nagrań', 'error');
            }
        }

        function displayRecordings(recordings) {
            const container = document.getElementById('recordings-list');
            container.innerHTML = '';

            if (recordings.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">Brak nagrań</p>';
                return;
            }

            recordings.forEach(recording => {
                const recordingElement = document.createElement('div');
                recordingElement.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg border';
                
                const duration = Math.floor(recording.duration / 60) + ':' + 
                               (recording.duration % 60).toString().padStart(2, '0');
                
                recordingElement.innerHTML = `
                    <div class="flex items-center flex-1">
                        <i class="fas fa-microphone text-blue-600 mr-4 text-xl"></i>
                        <div class="flex-1">
                            <div class="flex items-center space-x-4">
                                <div>
                                    <div class="font-medium text-gray-900">${recording.lead.name}</div>
                                    <div class="text-sm text-gray-600">${recording.lead.phone} • ${recording.lead.email}</div>
                                </div>
                                <div class="text-sm text-gray-500">
                                    <div>Pracownik: ${recording.employee.name}</div>
                                    <div>${new Date(recording.startTime).toLocaleString()}</div>
                                </div>
                                <div class="text-sm">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusClass(recording.status)}">
                                        ${getStatusText(recording.status)}
                                    </span>
                                </div>
                            </div>
                            ${recording.notes ? `<div class="text-sm text-gray-600 mt-2">${recording.notes}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 ml-4">
                        <span class="text-sm text-gray-500">${duration}</span>
                        <audio controls class="h-8">
                            <source src="${recording.recordingUrl}" type="audio/webm">
                            Twoja przeglądarka nie obsługuje odtwarzacza audio.
                        </audio>
                    </div>
                `;
                
                container.appendChild(recordingElement);
            });
        }

        function displayRecordingsPagination(pagination) {
            const container = document.getElementById('recordings-pagination');
            container.innerHTML = '';

            if (pagination.pages <= 1) return;

            const current = pagination.current;
            const pages = pagination.pages;
            
            let paginationHTML = '<div class="flex space-x-2">';
            
            // Previous button
            if (current > 1) {
                paginationHTML += `<button onclick="loadRecordingsPage(${current - 1})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Poprzednia</button>`;
            }
            
            // Page numbers
            for (let i = 1; i <= pages; i++) {
                if (i === current) {
                    paginationHTML += `<button class="px-3 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-md">${i}</button>`;
                } else {
                    paginationHTML += `<button onclick="loadRecordingsPage(${i})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">${i}</button>`;
                }
            }
            
            // Next button
            if (current < pages) {
                paginationHTML += `<button onclick="loadRecordingsPage(${current + 1})" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Następna</button>`;
            }
            
            paginationHTML += '</div>';
            container.innerHTML = paginationHTML;
        }

        function loadRecordingsPage(page) {
            // This would need to be implemented to load specific page
            loadRecordings();
        }

        function getStatusClass(status) {
            const classes = {
                'completed': 'bg-green-100 text-green-800',
                'in_progress': 'bg-yellow-100 text-yellow-800',
                'no_answer': 'bg-red-100 text-red-800',
                'not_interested': 'bg-gray-100 text-gray-800',
                'meeting_scheduled': 'bg-blue-100 text-blue-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }
    </script>
</body>
</html>
